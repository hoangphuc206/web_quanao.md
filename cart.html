<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè H√†ng - Shop √Åo F&V</title>
    <link href="css/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/menu.css">
    <link rel="stylesheet" href="css/cart.css">
</head>

<body>
    <div class="menu-toggle" id="menuToggle">
        <i class="bi bi-list"></i>
    </div>

    <div class="side-menu" id="sideMenu">
        <ul>
            <li><a href="index.html"><i class="bi bi-house-door"></i> Trang ch·ªß</a></li>
            <li class="has-dropdown">
                <a href="#"><i class="bi bi-tag"></i> Danh m·ª•c s·∫£n ph·∫©m</a>
                <ul class="sub-menu">
                    <li><a href="tshirt.html">√Åo thun</a></li>
                    <li><a href="polo.html">Polo</a></li>
                    <li><a href="outerwear.html">√Åo kho√°c</a></li>
                </ul>
            </li>
            <li><a href="aboutus.html"><i class="bi bi-info-circle"></i> V·ªÅ ch√∫ng t√¥i</a></li>
            <li><a href="lienhe.html"><i class="bi bi-envelope"></i> Li√™n h·ªá</a></li>
            <li><a href="user.html"><i class="bi bi-person"></i> T√†i kho·∫£n</a></li>
        </ul>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="content-wrapper" id="contentWrapper">
        <header>
            <div class="logo">
                <img src="image/·∫£nh F&V.png" width="80" height="80" alt="F&V Logo">
            </div>
            <div class="menu">
                <ul class="main-menu">
                    <li><a href="index.html">Trang ch·ªß</a></li>
                    <li class="has-dropdown">
                        <a href="#">S·∫£n ph·∫©m</a>
                        <ul class="sub-menu">
                            <li><a href="tshirt.html">√Åo thun</a></li>
                            <li><a href="polo.html">Polo</a></li>
                            <li><a href="outerwear.html">√Åo kho√°c</a></li>
                        </ul>
                    </li>
                    <li><a href="aboutus.html">V·ªÅ ch√∫ng t√¥i</a></li>
                    <li><a href="user.html">Th√¥ng tin ng∆∞·ªùi d√πng</a></li>
                    <li><a href="lienhe.html">Li√™n h·ªá</a></li>
                </ul>
            </div>
            <div class="others">
                <ul class="others-menu">
                    <li><input placeholder="Search" type="text"> <i class="bi bi-search"></i></li>
                    <li>
                        <a href="cart.html">
                            <i class="bi bi-bag-check-fill" title="Gi·ªè h√†ng"></i>
                            <span id="cart-count" class="badge rounded-pill bg-danger">0</span>
                        </a>
                    </li>
                    <li><a href="login.html"><i class="bi bi-person-circle" title="ƒêƒÉng nh·∫≠p"></i></a></li>
                    <li><a href="register.html"><i class="bi bi-pencil-square" title="ƒêƒÉng k√Ω"></i></a></li>
                </ul>
            </div>
        </header>
        <div class="cart-container">
            <div class="cart-header">
                <h1>Gi·ªè H√†ng</h1>
            </div>
            <div class="cart-content">
                <div class="cart-items-container">
                    
                    <div class="cart-items" id="cart-items">
                        <p class="text-center text-muted mt-5">ƒêang t·∫£i gi·ªè h√†ng...</p>
                    </div>
                    <div class="cart-summary">
                        <h2>T√≥m T·∫Øt ƒê∆°n H√†ng</h2>
                        <div class="cart-summary-row">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span>Mi·ªÖn ph√≠</span>
                        </div>
                        <div class="cart-summary-row total">
                            <span id="total-price">T·ªïng ti·ªÅn: 0 VNƒê</span>
                        </div>
                      <button id="checkout-momo" class="btn btn-primary"> Thanh To√°n MOMO</button>
 <button id="checkout-vnpay" class="btn btn-danger">Thanh To√°n VNPAY</button> 
        
 <button id="checkout-cod" class="btn btn-secondary">Thanh To√°n Khi Nh·∫≠n H√†ng (COD)</button>
                        <a href="index.html" class="btn-continue-shopping">Ti·∫øp t·ª•c mua s·∫Øm</a>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    </body>
    <footer>
        <div class="footer-container">
            <div class="footer-logo">
                <img src="image/·∫£nh F&V.png" width="120" height="120" alt="F&V Logo">
            </div>
            <div class="footer-info">
                <h3>Th√¥ng tin li√™n h·ªá</h3>
                <p>üìç ƒê·ªãa ch·ªâ: 29G7 DCT7 Ph∆∞·ªùng THT Qu·∫≠n 12 TPHCM</p>
                <p>üìû Hotline: 0787917097</p>
                <p>‚úâÔ∏è Email: hphuccc206@gmail.com</p>
            </div>
            <div class="footer-links">
                <h3>Li√™n k·∫øt nhanh</h3>
                <ul>
                    <ul>
                        <li><a href="index.html">Trang ch·ªß</a></li>
                        <li><a href="aboutus.html">V·ªÅ ch√∫ng t√¥i</a></li>
                        <li><a href="lienhe.html">Li√™n h·ªá</a></li>
                    </ul>
                </ul>
            </div>
            <div class="footer-social">
                <h3>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h3>
                <a href="#"><i class="bi bi-facebook"></i></a>
                <a href="#"><i class="bi bi-instagram"></i></a>
                <a href="#"><i class="bi bi-tiktok"></i></a>
            </div>
        </div>
        <p class="footer-bottom">¬© 2025 F&V Fashion. All rights reserved.</p>
    </footer>


    <script src="js/cart.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/product.js"></script>


 <!-- B·∫ÆT ƒê·∫¶U CODE G·ªåI MOMO FUNCTION -->
<script>
// === H√†m ph·ª• tr·ª£ ƒë·ªÉ l√†m s·∫°ch gi√° ti·ªÅn v√† l·∫•y s·ªë l∆∞·ª£ng ===
function getCartTotalPrice() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let totalPriceVND = 0;
    
    cart.forEach(item => {
        // Lo·∫°i b·ªè m·ªçi k√Ω t·ª± kh√¥ng ph·∫£i s·ªë v√† t√≠nh t·ªïng
        const cleanPriceString = (item.price || '0').replace(/[^0-9]/g, '');
        const price = parseFloat(cleanPriceString) || 0; 
        
        totalPriceVND += (price * item.quantity);
    });
    
    return totalPriceVND;
}

document.addEventListener("DOMContentLoaded", function () {
    const momoBtn = document.getElementById("checkout-momo");
    const vnpayBtn = document.getElementById("checkout-vnpay");
    const codBtn = document.getElementById("checkout-cod");

    // ----------------------------------------------------
    // X·ª≠ l√Ω Thanh to√°n MOMO
    // ----------------------------------------------------
    if (momoBtn) {
        momoBtn.addEventListener("click", async function () {
            const totalPrice = getCartTotalPrice();

            if (totalPrice === 0) {
                alert("Gi·ªè h√†ng ƒëang tr·ªëng!");
                return;
            }

            try {
                // G·ªçi Netlify Function MoMo
                const response = await fetch("/.netlify/functions/momo-create", { 
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ amount: totalPrice })
                });

                const data = await response.json();
                
                if (data?.payUrl) {
                    localStorage.removeItem("cart"); 
                    window.location.href = data.payUrl;
                } else {
                    alert("L·ªói: Kh√¥ng th·ªÉ t·∫°o URL thanh to√°n MoMo! Ki·ªÉm tra console log.");
                }

            } catch (err) {
                console.error("MoMo connection error:", err);
                alert("ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi MoMo.");
            }
        });
    }

    // ----------------------------------------------------
    // X·ª≠ l√Ω Thanh to√°n VNPAY
    // ----------------------------------------------------
    if (vnpayBtn) {
    vnpayBtn.addEventListener("click", async function (e) {
        e.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa n√∫t

        const totalPrice = getCartTotalPrice();

        if (totalPrice === 0) {
            alert("Gi·ªè h√†ng ƒëang tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m.");
            return;
        }
        
        // üö® T·∫°o Order ID DUY NH·∫§T. V√≠ d·ª•: FNV (T√™n C·ª≠a h√†ng) + Timestamp
        const orderId = 'FNV' + Date.now();
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i (loading)
        // showLoading(); 

        try {
            // G·ªçi Netlify Function VNPAY
            const response = await fetch("/.netlify/functions/vnpay-create", {¬†
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    amount: totalPrice,
                    orderId: orderId,
                    // D√πng t√™n c·ª≠a h√†ng c·ªßa b·∫°n
                    orderInfo: `Thanh toan don hang ${orderId} tren F&V Store`¬†
                })
            });

            // N·∫øu ph·∫£n h·ªìi HTTP kh√¥ng th√†nh c√¥ng (v√≠ d·ª•: 500 Server Error)
            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.message || `L·ªói HTTP: ${response.status}`);
            }

            const data = await response.json();
            
            // üö® B∆Ø·ªöC KH·∫ÆC PH·ª§C L·ªñI: Ki·ªÉm tra vnpUrl
            if (data?.vnpUrl) {
                // 1. D·ªçn d·∫πp gi·ªè h√†ng (Ch·ªâ n√™n d·ªçn d·∫πp khi giao d·ªãch th√†nh c√¥ng tr√™n VNPAY ho·∫∑c khi RETURN URL/IPN tr·∫£ v·ªÅ)
                // Tuy nhi√™n, n·∫øu b·∫°n mu·ªën d·ªçn d·∫πp ngay ƒë·ªÉ tr√°nh ng∆∞·ªùi d√πng ƒë·∫∑t l·∫°i, b·∫°n c√≥ th·ªÉ gi·ªØ l·∫°i.
                // localStorage.removeItem("cart"); 
                
                // 2. Chuy·ªÉn h∆∞·ªõng ƒë·∫øn c·ªïng VNPAY
                window.location.href = data.vnpUrl; 
            } else {
                // L·ªói khi server tr·∫£ v·ªÅ OK nh∆∞ng kh√¥ng c√≥ vnpUrl
                alert("L·ªói: Server ƒë√£ x·ª≠ l√Ω nh∆∞ng kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.");
                console.error("VNPAY API Response:", data);
            }

        } catch (err) {
            console.error("VNPAY Connection/Server Error:", err);
            alert(`ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh t·∫°o li√™n k·∫øt VNPAY: ${err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`);
        } finally {
            // ·∫®n tr·∫°ng th√°i t·∫£i, b·∫•t k·ªÉ th√†nh c√¥ng hay th·∫•t b·∫°i
            // hideLoading(); 
        }
    });
}

// ------------------------------------------------------------------------------------
// ## üì¶ X·ª≠ l√Ω Thanh to√°n COD (Thanh to√°n khi nh·∫≠n h√†ng)
// ------------------------------------------------------------------------------------
if (codBtn) {
    codBtn.addEventListener("click", function(e) {
        e.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh

        if (getCartTotalPrice() === 0) {
            alert("Gi·ªè h√†ng ƒëang tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m.");
            return;
        }

        // üö® THAY TH·∫æ b·∫±ng logic x·ª≠ l√Ω ƒë∆°n h√†ng COD th·ª±c t·∫ø c·ªßa b·∫°n
        // 1. G·ª≠i d·ªØ li·ªáu ƒë∆°n h√†ng COD l√™n Server/Netlify Function
        // V√≠ d·ª•: await fetch("/.netlify/functions/create-cod-order", { ... });
        // 2. X·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ server
        
        // Logic ƒë∆°n gi·∫£n cho COD
        localStorage.removeItem("cart");
        alert("ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t th√†nh c√¥ng (COD) v√† ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω. C·∫£m ∆°n b·∫°n!");
        
        // üö® THAY ƒê·ªîI: Chuy·ªÉn v·ªÅ trang k·∫øt qu·∫£ ho·∫∑c trang ch·ªß.
        // D·ª±a tr√™n h√¨nh ·∫£nh, t√¥i d√πng trang ch·ªß:
        window.location.href = "/"; // Ho·∫∑c l√† "/Trangchu.html" n·∫øu b·∫°n ƒë·∫∑t t√™n nh∆∞ v·∫≠y
    });
}

});
</script>
    

</html>
